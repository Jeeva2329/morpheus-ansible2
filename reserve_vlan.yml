---
- name: Update DB to reserve the next unused VLAN
  hosts: all
  gather_facts: yes
  become: yes
  become_user: root
  become_method: sudo
  tasks:
  #- name: Update the network config in Morpheus with the values gathered from the Operational workflow
  #  shell: /usr/bin/mysql -h 10.30.20.173 -uroot -p"{{ lookup('cypher','secret=secret/renmysqlpass') }}" -B -e "use vlan_capture; UPDATE vlan_capture set status="used", epg=\""{{ morpheus['customOptions']['fepgname'] }}"\", anp=\""{{ morpheus['customOptions']['fanpname'] }}"\", app_type=\""{{ morpheus['customOptions']['fapptype'] }}"\" where vlan LIKE \""{{ morpheus['results']['vlan'] }}"\";"
  #  args:
  #    executable: /bin/bash
  
  - name: Get the next available VLAN
    shell: /bin/mysql -h 10.30.20.173 -umorpheus -p"{{ lookup('cypher','secret=secret/renmysqlpass') }}" -B -e "use vlan_capture; select vlan from vlan_capture where status like 'unused' limit 1;"
    register: free_vlan
  
  - set_fact:
      free_vlan={{ free_vlan.stdout[6:] }}
  - debug: var=free_vlan
    run_once: true

      
 # - debug: 
  #    msg: "{{ morpheus['results']['vlan'] }}"
